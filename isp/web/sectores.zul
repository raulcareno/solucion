
<window   border="normal"
 >

    <zscript>    <![CDATA[
  import bean.EventDAO; 
  import java.util.ArrayList; 
  import jcinform.persistencia.*;
  import jcinform.conexion.*;
  import jcinform.bean.*;
  import java.math.BigDecimal;

  Session ses = Sessions.getCurrent();
    Administrador adm = new Administrador();
    List allEvents = adm.query("Select o from Sector as o");
    static Sector equi = new Sector();
    Permisos permiso = new Permisos();
    //SimpleTreeModel stm = new SimpleTreeModel(root);
//FUNCIONES


List cantones2 = adm.query("Select o from Canton as o ");

void llenar(Sector equi2){
   equi = equi2;
    nombre.value = equi.getNombre();

       if(equi2.getCanton() != null){
             try{
                      for (int i = 0; i <= cantones.getItems().size(); i++) {
                                    Canton tr0 = ((Canton)((Listitem)cantones.getItems().get(i)).getValue());
                                    int primero = tr0.getCodigo();
                                    int segundo = equi2.getCanton().getCodigo();
                                    if(primero == segundo){
                                        cantones.setSelectedItem((Listitem)cantones.getItems().get(i));
                                        bd1.value = equi2.getCanton().getNombre();
                                        break;
                                    }
                           }
                 }catch(Exception err){System.out.println("ERROR no tiene cursos asignados COMBO CURSOS: "+err);}


            }
    


    
}
void estado(Boolean estado,Boolean modificar){
    if(modificar){
        equi = (Sector)datos.selectedItem.value;
    }
    nombre.readonly = estado;
 

}


 void guardar(){
    if(nombre.value.equals("")){
            Messagebox.show("Ingrese todos los campos con (*) ...!", "Administrador Educativo", Messagebox.OK, Messagebox.ERROR);
            return;
    }
        equi.setNombre(nombre.value);
        equi.setCanton(cantones.selectedItem.value);
        
        if((!equi.getCodigo().equals(0)) ){
             adm.actualizar(equi);
                List children = datos.selectedItem.children;
               permiso.auditar("Sectores","Actualizar",""+equi.getCodigo()+" - "+equi.getNombre());
         }else{
                equi.setCodigo(adm.getNuevaClave("Sector","codigo"));
                adm.guardar(equi);
                permiso.auditar("Sectores","Guardar",""+equi.getCodigo()+" - "+equi.getNombre());
         }
                Messagebox.show("Registro Almacenado con Éxito...!", "Administrador Educativo", Messagebox.OK, Messagebox.INFORMATION);
                    guardar.disabled=true;
                    agregar.disabled=false;
                    estado(true,false);
                    llenar(new Sector(0));
                    buscar("");
    }

 Boolean verificar(String accion){
        return permiso.verificarPermiso("Sectores",accion);
 }
 void nuevo(){
    if(verificar("Agregar")){
       guardar.disabled=false;
        llenar(new Sector(0));
        estado(false,false);
        
    }else{
            Messagebox.show("No tiene permisos para realizar esta acción...!", "Administrador Educativo", Messagebox.OK, Messagebox.ERROR);
    }
}
 void move(){
        llenar((Sector)datos.selectedItem.value);
        modificar.disabled = false;
  }
void modificar(){
  if(verificar("Modificar")){
       guardar.disabled=false; estado(false,true);
    }else{
            Messagebox.show("No tiene permisos para realizar esta acción...!", "Administrador Educativo", Messagebox.OK, Messagebox.ERROR);
    }
}
void eliminar(){
  if(verificar("Eliminar")){
        try{
             equi = (Sector)datos.selectedItem.value;
             adm.eliminarObjeto(Sector.class, equi.getCodigo());
             permiso.auditar("Sectores","Eliminar",""+equi.getCodigo()+" - "+equi.getNombre());
            datos.removeItemAt(datos.getSelectedIndex());
            llenar(new Sector(0));
                Messagebox.show("Registro Eliminado con Éxito...!", "Administrador Educativo", Messagebox.OK, Messagebox.INFORMATION);
        }catch(Exception e){
            Messagebox.show("No se pudo eliminar el Registro...!", "Administrador Educativo", Messagebox.OK, Messagebox.ERROR);
        }
}else{
            Messagebox.show("No tiene permisos para realizar esta acción...!", "Administrador Educativo", Messagebox.OK, Messagebox.ERROR);
    }
}
   void buscar(String p){

      
        List equivaEncontrados = adm.query("Select o from Sector as o order by o.nombre");
        datos = new Listbox();
        int a=0;
            for (Iterator it = datos.getItems().iterator(); it.hasNext();) {
                    datos.getItems().remove(a);
                }
   
       
               for (Iterator it = equivaEncontrados.iterator(); it.hasNext();) {
                      Sector acceIt = (Sector) it.next();
                      Listitem li = new Listitem();
                      li.setValue(acceIt);
                      li.appendChild(new Listcell(acceIt.getCodigo()+""));
                      li.appendChild(new Listcell(acceIt.getNombre()+" "));
                      li.appendChild(new Listcell(acceIt.getCanton().getNombre()+" "));
                      datos.appendChild(li);
             }

    }
void cargar(Sector g){
equi.setPerfil(g);
}
  ]]>
    </zscript>
    <groupbox mold="3d" >
        <caption label="Agregar Sectores" />
	
        <grid width="100%">
            <rows>
                <row>   <span style="float:right"> Canton(*):</span>
                    <bandbox  width="400px" readonly="true"  id="bd1">
                        <bandpopup>
                            <vbox>
                                <listbox id="cantones" width="660px" rows="10"
                                                                                     onSelect="bd1.value=self.selectedItem.label;bd1.closeDropdown();">
                                    <listitem selected="true" forEach="${cantones2}" value="${each}">
                                        <listcell label="${each.nombre}" />
                                    </listitem>
                                </listbox>
                            </vbox>
                        </bandpopup>
                    </bandbox>
                </row>
                <row>
                    <span style="float:right"> Nombre Sector(*):</span>
                    <textbox id="nombre"  maxlength="100" cols="40" readonly="true"   />
                </row>
 

            </rows>
        </grid>
        <vbox>
            <vbox>
                <hbox>
                    <button image="/images/guardar.gif" id="guardar" label="Guardar"  disabled="true"  onClick="guardar();"/>
                    <button  image="/images/nuevo.gif" id="agregar" label="Agregar" onClick="nuevo();" />
                    <button  image="/images/editar.gif" id="modificar"  label="Modificar" disabled="true"  onClick="modificar()"/>
                    <button  image="/images/eliminar.gif" id="eliminar"  label="Eliminar" disabled="true"  onClick="eliminar();"/>
                </hbox>
            </vbox>

        </vbox>

    </groupbox>
    <groupbox width="100%" mold="3d" >

        <caption label="Busquedas" />
        <vbox>
   
            <hbox width="100%">
                <listbox onSelect="move();estado(true,false);eliminar.disabled=false;guardar.disabled=true" id="datos" width="100%">
                    <listhead>
                        <listheader  label="Código"/>
                        <listheader sort="auto" label="Sector"/>
                        <listheader sort="auto" label="Canton"/>

                    </listhead>
                    <listitem forEach="${allEvents}" value="${each}">
                        <listcell label="${each.codigo}" />
                        <listcell label="${each.nombre}" />
                        <listcell label="${each.canton.nombre}" />
                    </listitem>
                </listbox>


            </hbox>
        </vbox>
    </groupbox>
	

</window>
